{% extends "base.html" %}

{% block title %}لوحة التحكم{% endblock %}

{% block header %}لوحة التحكم{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    <!-- Total Sales Card -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100 text-blue-500">
                <i class="fas fa-cash-register text-2xl"></i>
            </div>
            <div class="mx-4">
                <h4 class="text-gray-500">إجمالي المبيعات</h4>
                <h3 class="text-2xl font-semibold" id="total-sales">...</h3>
            </div>
        </div>
    </div>
    
    <!-- Total Profit Card -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100 text-green-500">
                <i class="fas fa-chart-line text-2xl"></i>
            </div>
            <div class="mx-4">
                <h4 class="text-gray-500">إجمالي الأرباح</h4>
                <h3 class="text-2xl font-semibold" id="total-profits">...</h3>
            </div>
        </div>
    </div>
    
    <!-- Products Count Card -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-purple-100 text-purple-500">
                <i class="fas fa-boxes text-2xl"></i>
            </div>
            <div class="mx-4">
                <h4 class="text-gray-500">عدد المنتجات</h4>
                <h3 class="text-2xl font-semibold" id="products-count">...</h3>
            </div>
        </div>
    </div>
    
    <!-- Low Stock Alert Card -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-red-100 text-red-500">
                <i class="fas fa-exclamation-triangle text-2xl"></i>
            </div>
            <div class="mx-4">
                <h4 class="text-gray-500">منتجات قليلة المخزون</h4>
                <h3 class="text-2xl font-semibold" id="low-stock-count">...</h3>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity Section -->
<div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Recent Sales -->
    <div class="bg-white rounded-lg shadow">
        <div class="border-b px-6 py-4">
            <h2 class="font-semibold text-lg">آخر المبيعات</h2>
        </div>
        <div class="p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">التاريخ</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المنتج</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الكمية</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المبلغ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="recent-sales-table">
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" colspan="4">جاري التحميل...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 text-center">
                <a href="{{ url_for('sales_records') }}" class="text-indigo-600 hover:text-indigo-900">عرض كل المبيعات</a>
            </div>
        </div>
    </div>
    
    <!-- Recent Purchases -->
    <div class="bg-white rounded-lg shadow">
        <div class="border-b px-6 py-4">
            <h2 class="font-semibold text-lg">آخر المشتريات</h2>
        </div>
        <div class="p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">التاريخ</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المنتج</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الكمية</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المبلغ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="recent-purchases-table">
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" colspan="4">جاري التحميل...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 text-center">
                <a href="{{ url_for('purchases_records') }}" class="text-indigo-600 hover:text-indigo-900">عرض كل المشتريات</a>
            </div>
        </div>
    </div>
</div>

<!-- Low Stock Alert Section -->
<div class="mt-8 bg-white rounded-lg shadow">
    <div class="border-b px-6 py-4">
        <h2 class="font-semibold text-lg">تنبيهات المخزون</h2>
    </div>
    <div class="p-6">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المنتج</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الكمية المتبقية</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراء</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="low-stock-table">
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" colspan="3">جاري التحميل...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load dashboard data
        fetchDashboardData();
        
        // Refresh data every 60 seconds
        setInterval(fetchDashboardData, 60000);
    });
    
    function fetchDashboardData() {
        // Fetch total sales and profits
        fetch('/api/dashboard/stats')
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-sales').textContent = data.total_sales.toFixed(2) + ' ';
                document.getElementById('total-profits').textContent = data.total_profits.toFixed(2) + ' ' ;
                document.getElementById('products-count').textContent = data.products_count;
                document.getElementById('low-stock-count').textContent = data.low_stock_count;
            })
            .catch(error => {
                console.error('Error fetching dashboard stats:', error);
            });
        
        // Fetch recent sales
        fetch('/api/dashboard/recent-sales')
            .then(response => response.json())
            .then(data => {
                const salesTable = document.getElementById('recent-sales-table');
                salesTable.innerHTML = '';
                
                if (data.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" colspan="4">لا توجد مبيعات حديثة</td>`;
                    salesTable.appendChild(row);
                } else {
                    data.forEach(sale => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sale.product_name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.quantity}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.final_selling_price.toFixed(2)} $</td>
                        `;
                        salesTable.appendChild(row);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching recent sales:', error);
            });
        
        // Fetch recent purchases
        fetch('/api/dashboard/recent-purchases')
            .then(response => response.json())
            .then(data => {
                const purchasesTable = document.getElementById('recent-purchases-table');
                purchasesTable.innerHTML = '';
                
                if (data.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" colspan="4">لا توجد مشتريات حديثة</td>`;
                    purchasesTable.appendChild(row);
                } else {
                    data.forEach(purchase => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${purchase.date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${purchase.product_name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${purchase.quantity}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${purchase.total_price.toFixed(2)} $</td>
                        `;
                        purchasesTable.appendChild(row);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching recent purchases:', error);
            });
        
        // Fetch low stock products
        fetch('/api/dashboard/low-stock')
            .then(response => response.json())
            .then(data => {
                const lowStockTable = document.getElementById('low-stock-table');
                lowStockTable.innerHTML = '';
                
                if (data.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" colspan="3">لا توجد منتجات منخفضة المخزون</td>`;
                    lowStockTable.appendChild(row);
                } else {
                    data.forEach(product => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-500 font-semibold">${product.available_quantity}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <a href="${product.purchase_url}" class="text-indigo-600 hover:text-indigo-900">
                                    <i class="fas fa-plus-circle mr-1"></i> إضافة مخزون
                                </a>
                            </td>
                        `;
                        lowStockTable.appendChild(row);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching low stock products:', error);
            });
    }
</script>
{% endblock %}